<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>BookLingo Chatbot</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="../static/style.css" />
</head>

<body>
  <div id="wrap">
    <div id="chat">
      <h2>BookLingo</h2>

      <div id="messages">
        <div class="intro">
          <h3>ğŸ“– BookLingo'ya HoÅŸ Geldiniz!</h3>
          <p>
            Bu uygulama, yÃ¼klediÄŸiniz Ä°ngilizce kitaplardan kelime veya kalÄ±plarÄ±n
            anlamlarÄ±nÄ± bulur ve kitapta geÃ§tiÄŸi Ã¶rnek cÃ¼mlelerle aÃ§Ä±klar.
          </p>
          <ul>
            <li>ğŸ“˜ SaÄŸ taraftan bir <b>Pdf yÃ¼kleyin</b>.</li>
            <li>ğŸ’¬ ArdÄ±ndan, chat kutusuna bilmediÄŸiniz kelimeyi yazÄ±n.</li>
            <li>ğŸ¤– BookLingo, kitapta o kelimenin geÃ§tiÄŸi Ã¶rnekleri gÃ¶sterecek.</li>
          </ul>
          <p><i>Ã–rnek:</i> <code>dismantling my engine</code> veya <code>intrigued</code></p>
        </div>
        <div id="typing">ğŸ¤– Bot yazÄ±yor...</div>
      </div>

      <div id="input-box">
        <input id="input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." autofocus />
        <button id="sendBtn" onclick="send()">GÃ¶nder</button>
      </div>
    </div>

    <div id="side">
      <h3>PDF YÃ¼kle</h3>
      <div id="drop" class="drop">
        DosyayÄ± buraya sÃ¼rÃ¼kle-bÄ±rak <br />
        <small>ya da</small><br />
        <input id="file" type="file" accept="application/pdf" multiple />
      </div>
      <button id="uploadBtn">YÃ¼kle</button>
      <small>YÃ¼klenen PDFâ€™ler otomatik olarak chunkâ€™lanÄ±r, embed edilir ve DBâ€™ye eklenir.</small>
      <h4>GÃ¼nlÃ¼k</h4>
      <div id="uploadLog"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    const typing = document.getElementById('typing');
    const sendBtn = document.getElementById('sendBtn');

    // Enter ile gÃ¶nder
    input.addEventListener("keypress", e => { if (e.key === "Enter") send(); });

    async function send() {
      const query = input.value.trim();
      if (!query) return;

      // Ä°lk mesajda intro'yu kaldÄ±r
      const intro = document.querySelector('.intro');
      if (intro) intro.remove();

      appendMessage('user', query);
      input.value = '';
      input.disabled = true; sendBtn.disabled = true;
      typing.style.display = 'block'; 

      try {
        const res = await fetch('/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const data = await res.json();
        appendMessage('bot', data.response || 'Bir hata oluÅŸtu.');
      } catch (e) {
        appendMessage('bot', 'âš ï¸ Sunucuya baÄŸlanÄ±lamadÄ±.');
      } finally {
        typing.style.display = 'none'; 
        input.disabled = false; sendBtn.disabled = false; input.focus();
      }
    }

    function appendMessage(sender, text) {
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      const formatted = sender === 'bot' ? marked.parse(text) : text;
      div.innerHTML = `${formatted}`;
      
      messages.insertBefore(div, typing);
      messages.scrollTop = messages.scrollHeight;
    }

    // â”€â”€ Upload UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadLog = document.getElementById('uploadLog');

    ;['dragenter', 'dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
    ;['dragleave', 'drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e => { fileInput.files = e.dataTransfer.files; });

    uploadBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) { log('âš ï¸ LÃ¼tfen PDF seÃ§in.'); return; }

      uploadBtn.disabled = true;
      const originalText = uploadBtn.textContent;
      uploadBtn.textContent = "â³ YÃ¼kleniyor...";
      log("PDF yÃ¼kleme ve embedding iÅŸlemi baÅŸlatÄ±ldÄ±...");

      try {
        const fd = new FormData();
        for (const f of fileInput.files) fd.append('files', f);
        const res = await fetch('/upload', { method: 'POST', body: fd });

        if (!res.ok) {
          log(`âŒ Sunucu hatasÄ±: ${res.status}`);
          return;
        }

        const data = await res.json();
        if (!data.ok) { log('âŒ YÃ¼kleme baÅŸarÄ±sÄ±z.'); return; }

        log(`âœ… <b>Model:</b> <code>${data.model}</code>`);
        data.results.forEach(r => {
          log(`ğŸ“˜ <b>${escapeHtml(r.file)}</b> â†’ chunks: ${r.chunks}, added: ${r.added}, collection: ${r.collection}`);
        });

        log("ğŸ‰ Ä°ÅŸlem tamamlandÄ±!");
      } catch (e) {
        console.error(e);
        log('âŒ Sunucu hatasÄ± / baÄŸlantÄ± sorunu.');
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = originalText;
      }
    });

    function log(html) {
      const p = document.createElement('div');
      p.innerHTML = html;
      uploadLog.appendChild(p);
      uploadLog.scrollTop = uploadLog.scrollHeight;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c]));
    }
  </script>
</body>
</html>

</html>